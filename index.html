<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Container MM INFO (Ë≤®Ê´ÉÁÆ°ÁêÜË≥áË®ä)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #4CAF50; --bg-color: #f7f9fc; --card-bg: #ffffff;
            --danger-color: #e53935; --copy-color: #FF9800; --view-color: #212121;
            --accent-color: #673AB7; --input-border: #ddd;
        }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background-color: var(--bg-color); margin: 0; padding: 0;
            display: flex; justify-content: center; min-height: 100vh;
        }
        #status-modal, #settings-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 9999;
            display: none; align-items: center; justify-content: center;
        }
        .modal-box {
            background: white; padding: 25px; border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1); text-align: center; width: 90%; max-width: 450px;
            max-height: 90vh; overflow-y: auto; 
        }
        .login-input {
            width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ccc; 
            border-radius: 8px; font-size: 16px; box-sizing: border-box;
        }
        .spinner {
            border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-color);
            border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite;
            margin: 0 auto 15px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        #app-screen { width: 100%; max-width: 500px; padding: 10px; box-sizing: border-box; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .header-title h2 { margin: 0; color: #333; font-size: 1.6rem; text-align: center; font-weight: 800; }
        .author-header { font-size: 0.8rem; color: #999; text-align: center; }

        .card { background: var(--card-bg); padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 12px; }
        .section-title { font-weight: bold; color: #555; margin-bottom: 8px; display: block; font-size: 1rem; border-left: 4px solid var(--primary-color); padding-left: 8px; }
        
        /* ÂúñÁâáÂÆπÂô® */
        .preview-container-box {
            max-width: 100%; position: relative; display: flex; justify-content: center; align-items: center; overflow: hidden;
            background: #e0e0e0; border-radius: 8px; min-height: 150px; cursor: pointer;
        }
        .ratio-4-3 { aspect-ratio: 4 / 3; } .ratio-16-9 { aspect-ratio: 16 / 9; } .ratio-1-1 { aspect-ratio: 1 / 1; }
        .preview-img-display { width: 100%; height: 100%; object-fit: cover; display: none; }
        
        /* Ë°®ÂñÆÂÖÉÁ¥† */
        .input-group { margin-bottom: 10px; display: flex; flex-direction: column; }
        .text-input, textarea, select { 
            width: 100%; padding: 10px; border: 1px solid var(--input-border); 
            border-radius: 6px; font-size: 15px; box-sizing: border-box;
        }
        .time-input-row { display: flex; gap: 5px; }
        .btn-update-time { background: #00bcd4; color: white; border: none; padding: 0 15px; border-radius: 6px; cursor: pointer; }

        /* Áµ±Ë®àÂçÄÂ°äÊ®£Âºè */
        .stats-controls { display: flex; gap: 10px; margin-bottom: 15px; }
        .chart-wrapper { height: 250px; width: 100%; }

        /* ÊåâÈàïË®≠Ë®à */
        .footer-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding-bottom: 30px; }
        .btn-main { 
            height: 60px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold;
            color: white; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center;
        }
        .btn-save { background-color: var(--primary-color); }
        .btn-copy { background-color: var(--copy-color); }
        .btn-stats { background-color: var(--accent-color); grid-column: span 2; }
        .btn-voice { background: #f0f0f0; color: #333; margin-top: 5px; border: 1px solid #ccc; padding: 10px; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .btn-voice.recording { background-color: var(--danger-color); color: white; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.8; } 100% { opacity: 1; } }

        @media (min-width: 900px) {
            #app-screen { max-width: 1100px; }
            .main-content-wrapper { display: flex; gap: 20px; }
            .left-col { flex: 2; } .right-col { flex: 3; }
        }
    </style>
</head>
<body>

    <div id="status-modal">
        <div class="modal-box">
            <div id="status-spinner" class="spinner"></div>
            <div id="status-icon" style="display:none; font-size: 40px;"></div>
            <h3 id="status-text">Uploading...</h3>
            <p id="status-subtext"></p>
            <button id="status-close-btn" onclick="closeStatusModal()" class="btn-main" style="background:#2196F3; height:40px; width:100%; margin-top:10px;">OK</button>
        </div>
    </div>

    <div id="app-screen">
        <div class="author-header">Author: DEREK LIN (v7.0 Stats Edition)</div>
        <div class="header">
            <div style="width: 36px;"></div>
            <div class="header-title"><h2>Container MM INFO<br>Ë≤®Ê´ÉÁÆ°ÁêÜË≥áË®ä</h2></div>
            <div onclick="openSettings()" style="cursor:pointer; font-size:24px;">‚öôÔ∏è</div>
        </div>

        <div class="card">
            <div class="input-group">
                <label style="font-weight:bold; font-size:0.9rem;">Employee ID (Âì°Â∑•Á∑®Ëôü):</label>
                <input type="text" id="input-employee-id" class="text-input" placeholder="ÂÑ≤Â≠òÂæåËá™ÂãïË®òÈåÑ">
            </div>
        </div>

        <div class="main-content-wrapper">
            <div class="left-col">
                <div class="card">
                    <span class="section-title">1. Truck Plate Photo</span>
                    <div style="display:flex; gap:5px; margin-bottom:10px;">
                        <button class="btn-voice" style="flex:1" onclick="triggerFile('cam1')">üì∑ Cam</button>
                        <button class="btn-voice" style="flex:1" onclick="triggerFile('gal1')">üñºÔ∏è Gallery</button>
                    </div>
                    <div id="prev-box1" class="preview-container-box ratio-4-3" onclick="triggerFile('cam1')">
                        <span id="label1">Tap for Photo A</span>
                        <img id="img1" class="preview-img-display">
                    </div>
                    <input type="file" id="cam1" capture="environment" accept="image/*" style="display:none" onchange="handleFile(this, 1)">
                    <input type="file" id="gal1" accept="image/*" style="display:none" onchange="handleFile(this, 1)">
                </div>

                <div class="card">
                    <span class="section-title">2. Material Photo</span>
                    <div style="display:flex; gap:5px; margin-bottom:10px;">
                        <button class="btn-voice" style="flex:1" onclick="triggerFile('cam2')">üì∑ Cam</button>
                        <button class="btn-voice" style="flex:1" onclick="triggerFile('gal2')">üñºÔ∏è Gallery</button>
                    </div>
                    <div id="prev-box2" class="preview-container-box ratio-4-3" onclick="triggerFile('cam2')">
                        <span id="label2">Tap for Photo B</span>
                        <img id="img2" class="preview-img-display">
                    </div>
                    <input type="file" id="cam2" capture="environment" accept="image/*" style="display:none" onchange="handleFile(this, 2)">
                    <input type="file" id="gal2" accept="image/*" style="display:none" onchange="handleFile(this, 2)">
                </div>
            </div>

            <div class="right-col">
                <div class="card" style="border: 2px solid var(--accent-color);">
                    <span class="section-title" style="color:var(--accent-color);">Monthly Statistics (ÊúàÁµ±Ë®àÂúñ)</span>
                    <div class="stats-controls">
                        <select id="stats-range" class="text-input" style="flex:2">
                            <option value="6">Last 6 Months</option>
                            <option value="12">Last 12 Months</option>
                            <option value="all">All Records</option>
                        </select>
                        <button onclick="fetchAndRenderStats()" class="btn-voice" style="flex:1; margin:0; background:var(--accent-color); color:white; border:none;">üìä Run</button>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="monthlyChart"></canvas>
                    </div>
                </div>

                <div class="card">
                    <span class="section-title">Container Information</span>
                    <div class="input-group">
                        <label>SAP CODE:</label>
                        <input type="text" id="in-sap" class="text-input">
                    </div>
                    <div class="input-group">
                        <label>Material Name:</label>
                        <input type="text" id="in-mat" class="text-input">
                    </div>
                    <div class="input-group">
                        <label>Arrival Time (DD/MM/YYYY hh:mm):</label>
                        <div class="time-input-row">
                            <input type="text" id="in-start" class="text-input" oninput="calcTime()">
                            <button onclick="setTime('in-start')" class="btn-update-time">‚è±Ô∏è</button>
                        </div>
                    </div>
                    <div class="input-group">
                        <label>End Time:</label>
                        <div class="time-input-row">
                            <input type="text" id="in-stop" class="text-input" oninput="calcTime()">
                            <button onclick="setTime('in-stop')" class="btn-update-time">‚è±Ô∏è</button>
                        </div>
                    </div>
                    <div class="input-group">
                        <label>Total Time:</label>
                        <input type="text" id="in-total" class="text-input" readonly style="background:#f0f0f0; font-weight:bold;">
                    </div>
                    <div class="input-group">
                        <label>Truck/Plate Num:</label>
                        <input type="text" id="in-plate" class="text-input">
                    </div>
                    <div class="input-group">
                        <label>Total Stock (Auto Calc):</label>
                        <input type="text" id="in-stock" class="text-input" readonly style="background:#f0f0f0;">
                    </div>
                    <div class="input-group">
                        <label>Notes:</label>
                        <textarea id="in-note"></textarea>
                        <button class="btn-voice" id="voice-btn" onclick="toggleVoice()">üé§ Voice Input</button>
                    </div>
                </div>

                <div class="footer-btns">
                    <button class="btn-main btn-copy" onclick="copyData()">üìã Copy</button>
                    <button class="btn-main btn-save" id="save-btn" onclick="saveData()">üíæ Save to Cloud</button>
                </div>
            </div>
        </div>
    </div>

    <div id="settings-modal">
        <div class="modal-box">
            <h3>Settings</h3>
            <label>Ratio:</label>
            <select id="set-ratio" class="text-input"><option value="4/3">4:3</option><option value="16/9">16:9</option></select>
            <button class="btn-main btn-save" onclick="closeSettings()" style="margin-top:20px; height:40px;">Close</button>
        </div>
    </div>

<script>
    // --- Âü∫Á§éÈÖçÁΩÆ ---
    const GAS_URL = "https://script.google.com/macros/s/AKfycbxX-XRuXqIB7JJopFGYaHtiAk6kZfe19bFihOd7HCxrA-ffKQGXDoIfJwwPYFLZER8c/exec";
    let processedImgs = { 1:"", 2:"" };
    let myChart = null;

    // --- Áµ±Ë®àÈÇèËºØ ---
    async function fetchAndRenderStats() {
        const range = document.getElementById('stats-range').value;
        showStatus('loading', 'Fetching data...', 'Ê≠£Âú®ÂæûË©¶ÁÆóË°®ÂΩôÊï¥Ë≥áÊñô');
        
        try {
            const resp = await fetch(`${GAS_URL}?action=loadRecords`);
            const res = await resp.json();
            closeStatusModal();

            if (res.result === 'success') {
                processStatsData(res.data, range);
            }
        } catch (e) {
            showStatus('error', 'Fetch Failed', e.message);
        }
    }

    
    function processStatsData(rawData, range) {
        let stats = {};
        rawData.forEach(item => {
            if (!item.startTime) return;
            // È†êÊúüÊ†ºÂºè DD/MM/YYYY
            const parts = item.startTime.split(' ')[0].split('/');
            if (parts.length === 3) {
                const ym = `${parts[2]}-${parts[1]}`; // YYYY-MM
                stats[ym] = (stats[ym] || 0) + 1;
            }
        });

        let sortedKeys = Object.keys(stats).sort();
        if (range !== 'all') sortedKeys = sortedKeys.slice(-parseInt(range));

        const labels = sortedKeys;
        const values = sortedKeys.map(k => stats[k]);

        renderChart(labels, values);
    }

    function renderChart(labels, values) {
        const ctx = document.getElementById('monthlyChart').getContext('2d');
        if (myChart) myChart.destroy();
        
        myChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Arrival Count',
                    data: values,
                    backgroundColor: 'rgba(103, 58, 183, 0.6)',
                    borderColor: 'rgb(103, 58, 183)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
            }
        });
    }

    // --- Ê†∏ÂøÉË°®ÂñÆÈÇèËºØ ---
    function setTime(id) {
        const now = new Date();
        const str = `${String(now.getDate()).padStart(2,'0')}/${String(now.getMonth()+1).padStart(2,'0')}/${now.getFullYear()} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
        document.getElementById(id).value = str;
        calcTime();
    }

    function calcTime() {
        const s = document.getElementById('in-start').value;
        const e = document.getElementById('in-stop').value;
        const res = document.getElementById('in-total');
        if(!s || !e) return;
        
        const parse = (str) => {
            const m = str.match(/(\d{2})\/(\d{2})\/(\d{4}) (\d{2}):(\d{2})/);
            return m ? new Date(m[3], m[2]-1, m[1], m[4], m[5]) : null;
        };
        const d1 = parse(s), d2 = parse(e);
        if(d1 && d2) {
            const diff = Math.round((d2 - d1) / 60000);
            res.value = diff >= 0 ? `${diff} min` : "Time Error";
        }
    }

    function triggerFile(id) { document.getElementById(id).click(); }
    
    function handleFile(input, slot) {
        if (!input.files[0]) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                let w = img.width, h = img.height;
                if(w > 800) { h *= 800/w; w = 800; }
                canvas.width = w; canvas.height = h;
                canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                processedImgs[slot] = canvas.toDataURL('image/jpeg', 0.8);
                document.getElementById(`img${slot}`).src = processedImgs[slot];
                document.getElementById(`img${slot}`).style.display = 'block';
                document.getElementById(`label${slot}`).style.display = 'none';
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(input.files[0]);
    }

    async function saveData() {
        const data = {
            employeeId: document.getElementById('input-employee-id').value,
            machine: document.getElementById('in-sap').value,
            formNo: document.getElementById('in-mat').value,
            startTimeFull: document.getElementById('in-start').value,
            stopTimeFull: document.getElementById('in-stop').value,
            plateNum: document.getElementById('in-plate').value,
            selfActions: document.getElementById('in-note').value,
            image1: processedImgs[1], image2: processedImgs[2]
        };

        if(!data.formNo) return alert("Material Name is required");

        showStatus('loading', 'Saving...', 'Ë≥áÊñôËàáÂúñÁâáÂêåÊ≠•‰∏≠');
        try {
            const resp = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify(data) });
            const res = await resp.json();
            if(res.result === 'success') {
                showStatus('success', 'Saved!', 'Â∑≤ÊàêÂäüÂØ´ÂÖ•Ë©¶ÁÆóË°®');
                setTimeout(fetchAndRenderStats, 1000); // Â≠òÂÆåËá™ÂãïÂà∑ÂúñË°®
            }
        } catch (e) {
            showStatus('error', 'Save Failed', e.message);
        }
    }

    // --- UI ËºîÂä© ---
    function showStatus(type, h, s) {
        document.getElementById('status-modal').style.display = 'flex';
        document.getElementById('status-text').innerText = h;
        document.getElementById('status-subtext').innerText = s;
        document.getElementById('status-spinner').style.display = type === 'loading' ? 'block' : 'none';
        document.getElementById('status-icon').style.display = type !== 'loading' ? 'block' : 'none';
        document.getElementById('status-close-btn').style.display = type !== 'loading' ? 'block' : 'none';
    }
    function closeStatusModal() { document.getElementById('status-modal').style.display = 'none'; }
    function openSettings() { document.getElementById('settings-modal').style.display = 'flex'; }
    function closeSettings() { document.getElementById('settings-modal').style.display = 'none'; }

    window.onload = () => {
        document.getElementById('input-employee-id').value = localStorage.getItem('empId') || "";
        fetchAndRenderStats(); // È†ÅÈù¢ÈñãÂïüËá™ÂãïË∑ë‰∏ÄÊ¨°Áµ±Ë®à
    };
</script>
</body>
</html>
